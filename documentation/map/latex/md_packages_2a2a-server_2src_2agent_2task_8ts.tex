\chapter{src/agent/task.\+ts }
\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts}{}\label{md_packages_2a2a-server_2src_2agent_2task_8ts}\index{src/agent/task.ts@{src/agent/task.ts}}
\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md40}%
\Hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md40}%


这个文件实现了 Task 类，负责处理代理任务的核心逻辑。\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md41}{}\doxysection{\texorpdfstring{主要功能}{主要功能}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md41}
\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md42}{}\doxysubsection{\texorpdfstring{Task 类}{Task 类}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md42}
Task 类负责管理单个代理任务的执行，包括工具调度、状态管理、事件处理等。\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md43}{}\doxysubsubsection{\texorpdfstring{构造函数}{构造函数}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md43}

\begin{DoxyCode}{0}
\DoxyCodeLine{private\ constructor(}
\DoxyCodeLine{\ \ id:\ string,}
\DoxyCodeLine{\ \ contextId:\ string,}
\DoxyCodeLine{\ \ config:\ Config,}
\DoxyCodeLine{\ \ eventBus?:\ ExecutionEventBus,}
\DoxyCodeLine{)}

\end{DoxyCode}


参数：
\begin{DoxyItemize}
\item {\ttfamily id}\+: 任务 ID
\item {\ttfamily context\+Id}\+: 上下文 ID
\item {\ttfamily config}\+: 配置对象
\item {\ttfamily event\+Bus}\+: 执行事件总线（可选）
\end{DoxyItemize}\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md44}{}\doxysubsubsection{\texorpdfstring{静态方法}{静态方法}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md44}
\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md45}{}\doxysubsubsubsection{\texorpdfstring{{\ttfamily create}}{{\ttfamily create}}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md45}

\begin{DoxyCode}{0}
\DoxyCodeLine{static\ async\ create(}
\DoxyCodeLine{\ \ id:\ string,}
\DoxyCodeLine{\ \ contextId:\ string,}
\DoxyCodeLine{\ \ config:\ Config,}
\DoxyCodeLine{\ \ eventBus?:\ ExecutionEventBus,}
\DoxyCodeLine{):\ Promise<Task>}

\end{DoxyCode}


创建新任务实例。

参数：
\begin{DoxyItemize}
\item {\ttfamily id}\+: 任务 ID
\item {\ttfamily context\+Id}\+: 上下文 ID
\item {\ttfamily config}\+: 配置对象
\item {\ttfamily event\+Bus}\+: 执行事件总线（可选）
\end{DoxyItemize}

返回：
\begin{DoxyItemize}
\item Promise$<$\+Task$>$\+: 任务实例
\end{DoxyItemize}\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md46}{}\doxysubsubsection{\texorpdfstring{方法}{方法}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md46}
\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md47}{}\doxysubsubsubsection{\texorpdfstring{{\ttfamily get\+Metadata}}{{\ttfamily get\+Metadata}}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md47}

\begin{DoxyCode}{0}
\DoxyCodeLine{async\ getMetadata():\ Promise<TaskMetadata>}

\end{DoxyCode}


获取任务元数据。

返回：
\begin{DoxyItemize}
\item Promise$<$\+Task\+Metadata$>$\+: 任务元数据
\end{DoxyItemize}\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md48}{}\doxysubsubsubsection{\texorpdfstring{工具调用相关方法}{工具调用相关方法}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md48}

\begin{DoxyItemize}
\item {\ttfamily wait\+For\+Pending\+Tools()\+: Promise\texorpdfstring{$<$}{<}void\texorpdfstring{$>$}{>}} -\/ 等待待处理的工具调用完成
\item {\ttfamily cancel\+Pending\+Tools(reason\+: string)\+: void} -\/ 取消待处理的工具调用
\item {\ttfamily schedule\+Tool\+Calls(requests\+: Tool\+Call\+Request\+Info\mbox{[}$\,$\mbox{]}, abort\+Signal\+: Abort\+Signal)\+: Promise\texorpdfstring{$<$}{<}void\texorpdfstring{$>$}{>}} -\/ 调度工具调用
\item {\ttfamily get\+And\+Clear\+Completed\+Tools()\+: Completed\+Tool\+Call\mbox{[}\mbox{]}} -\/ 获取并清除已完成的工具调用
\item {\ttfamily add\+Tool\+Responses\+To\+History(completed\+Tools\+: Completed\+Tool\+Call\mbox{[}$\,$\mbox{]})\+: void} -\/ 将工具响应添加到历史记录
\item {\ttfamily send\+Completed\+Tools\+To\+Llm(completed\+Tool\+Calls\+: Completed\+Tool\+Call\mbox{[}$\,$\mbox{]}, aborted\+: Abort\+Signal)\+: Async\+Generator\texorpdfstring{$<$}{<}Server\+Gemini\+Stream\+Event\texorpdfstring{$>$}{>}} -\/ 将已完成的工具调用发送给 LLM
\end{DoxyItemize}\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md49}{}\doxysubsubsubsection{\texorpdfstring{消息处理方法}{消息处理方法}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md49}

\begin{DoxyItemize}
\item {\ttfamily accept\+Agent\+Message(event\+: Server\+Gemini\+Stream\+Event)\+: Promise\texorpdfstring{$<$}{<}void\texorpdfstring{$>$}{>}} -\/ 接受代理消息
\item {\ttfamily accept\+User\+Message(request\+Context\+: Request\+Context, aborted\+: Abort\+Signal)\+: Async\+Generator\texorpdfstring{$<$}{<}Server\+Gemini\+Stream\+Event\texorpdfstring{$>$}{>}} -\/ 接受用户消息
\end{DoxyItemize}\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md50}{}\doxysubsubsubsection{\texorpdfstring{状态管理方法}{状态管理方法}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md50}

\begin{DoxyItemize}
\item {\ttfamily set\+Task\+State\+And\+Publish\+Update(...)}\+: 设置任务状态并发布更新
\item {\ttfamily \+\_\+send\+Text\+Content(content\+: string)\+: void} -\/ 发送文本内容
\item {\ttfamily \+\_\+send\+Thought(content\+: Thought\+Summary)\+: void} -\/ 发送思考内容
\end{DoxyItemize}\hypertarget{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md51}{}\doxysubsubsubsection{\texorpdfstring{私有方法}{私有方法}}\label{md_packages_2a2a-server_2src_2agent_2task_8ts_autotoc_md51}

\begin{DoxyItemize}
\item {\ttfamily \+\_\+reset\+Tool\+Completion\+Promise()\+: void} -\/ 重置工具完成 Promise
\item {\ttfamily \+\_\+register\+Tool\+Call(tool\+Call\+Id\+: string, status\+: string)\+: void} -\/ 注册工具调用
\item {\ttfamily \+\_\+resolve\+Tool\+Call(tool\+Call\+Id\+: string)\+: void} -\/ 解析工具调用
\item `\+\_\+create\+Text\+Message(text\+: string, role\+: \textquotesingle{}agent' \texorpdfstring{$\vert$}{|} \textquotesingle{}user\textquotesingle{} = \textquotesingle{}agent\textquotesingle{})\+: Message{\ttfamily  -\/ 创建文本消息}
\item {\ttfamily }\+\_\+create\+Status\+Update\+Event(...){\ttfamily  -\/ 创建状态更新事件}
\item {\ttfamily }\+\_\+scheduler\+Output\+Update(tool\+Call\+Id\+: string, output\+Chunk\+: string)\+: void{\ttfamily  -\/ 调度器输出更新}
\item {\ttfamily }\+\_\+scheduler\+All\+Tool\+Calls\+Complete(completed\+Tool\+Calls\+: Completed\+Tool\+Call\mbox{[}$\,$\mbox{]})\+: Promise$<$void$>${\ttfamily  -\/ 所有工具调用完成}
\item {\ttfamily }\+\_\+scheduler\+Tool\+Calls\+Update(tool\+Calls\+: Tool\+Call\mbox{[}$\,$\mbox{]})\+: void{\ttfamily  -\/ 工具调用更新}
\item {\ttfamily }create\+Scheduler()\+: Core\+Tool\+Scheduler{\ttfamily  -\/ 创建调度器}
\item {\ttfamily }tool\+Status\+Message(tc\+: Tool\+Call, task\+Id\+: string, context\+Id\+: string)\+: Message{\ttfamily  -\/ 工具状态消息}
\item {\ttfamily }get\+Proposed\+Content(file\+\_\+path\+: string, old\+\_\+string\+: string, new\+\_\+string\+: string)\+: Promise$<$string$>${\ttfamily  -\/ 获取提议的内容}
\item {\ttfamily }\+\_\+apply\+Replacement(current\+Content\+: string \texorpdfstring{$\vert$}{|} null, old\+String\+: string, new\+String\+: string, is\+New\+File\+: boolean)\+: string{\ttfamily  -\/ 应用替换}
\item {\ttfamily }\+\_\+handle\+Tool\+Confirmation\+Part(part\+: Part)\+: Promise$<$boolean$>$\`{} -\/ 处理工具确认部分 
\end{DoxyItemize}