# app.test.ts

## 概述

`app.test.ts` 是 a2a-server 包中 HTTP 应用的端到端测试文件。该文件使用 Vitest 测试框架和 Supertest 库来测试 Express 应用的功能，包括任务创建、状态更新和工具调用处理。

## 测试内容

### E2E 测试套件
该文件包含多个端到端测试，验证应用的核心功能：

1. **基本任务创建和状态流测试**:
   - 创建新任务并通过 SSE 流接收状态更新
   - 验证文本内容事件和最终的输入请求状态

2. **工具调用和审批流程测试**:
   - 测试单个工具调用的调度和审批等待
   - 验证工具调用更新事件的正确性

3. **多个工具调用测试**:
   - 测试单轮中多个工具调用的处理
   - 验证每个工具调用的状态更新序列

4. **无需审批的工具调用测试**:
   - 测试自动执行的工具调用流程
   - 验证从调度到执行完成的完整状态流

5. **YOLO 模式测试**:
   - 测试绕过工具审批的 YOLO 模式
   - 验证工具调用的自动执行流程

### 端点测试套件
另一个测试套件专注于验证 HTTP 端点：

1. **任务创建端点** (`POST /tasks`):
   - 验证任务创建功能和返回的任务 ID

2. **任务元数据获取端点** (`GET /tasks/:taskId/metadata`):
   - 验证特定任务元数据的获取

3. **所有任务元数据获取端点** (`GET /tasks/metadata`):
   - 验证所有任务元数据的获取

4. **不存在任务的处理**:
   - 验证对不存在任务的正确错误响应

5. **代理卡元数据端点** (`GET /.well-known/agent-card.json`):
   - 验证代理元数据的正确返回

## 使用的技术

- **Vitest**: 测试框架，提供测试结构和断言
- **Supertest**: HTTP 测试库，用于测试 Express 应用
- **Mocking**: 大量使用 `vi.mock()` 和 `vi.fn()` 来模拟依赖模块
- **SSE (Server-Sent Events)**: 测试实时状态更新流

## 依赖模块

- `@google/gemini-cli-core`: 核心功能和类型
- `@a2a-js/sdk`: SDK 类型和功能
- `express`: Express 应用类型
- `supertest`: HTTP 测试库
- `../utils/testing_utils.js`: 测试工具函数
- `../config/config.js`: 配置模块

## 测试策略

该测试文件采用端到端测试策略，模拟真实的 API 调用场景，验证整个应用的数据流和状态转换。通过模拟外部依赖，专注于测试应用本身的逻辑和行为。